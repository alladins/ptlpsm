# ë©”ë‰´ ê¶Œí•œ ì²´í¬ ì‹œìŠ¤í…œ

> **ìµœì¢… ìˆ˜ì •ì¼**: 2025-12-28
> **ê´€ë ¨ íŒŒì¼**: `stores/permission.ts`, `components/admin/SidebarMenu.vue`, `middleware/auth.ts`

## 1. ê°œìš”

ì‚¬ìš©ì ì—­í• (Role) ê¸°ë°˜ ë©”ë‰´ ì ‘ê·¼ ì œì–´(RBAC) ì‹œìŠ¤í…œì…ë‹ˆë‹¤.

### 1.1 í•µì‹¬ ì›ì¹™

| ì›ì¹™ | ì„¤ëª… |
|------|------|
| **ë³´ì•ˆ ìš°ì„ ** | APIì—ì„œ ëª…ì‹œì ìœ¼ë¡œ ê¶Œí•œì„ ë°›ì§€ ì•Šìœ¼ë©´ ë©”ë‰´ ìˆ¨ê¹€ |
| **ê´€ë¦¬ì ì˜ˆì™¸** | SYSTEM_ADMIN, LEADPOWER_MANAGERëŠ” ì „ì²´ ì ‘ê·¼ |
| **ìºì‹±** | ë©”ë‰´ ê¶Œí•œ 5ë¶„ ìºì‹±ìœ¼ë¡œ ì„±ëŠ¥ ìµœì í™” |

### 1.2 ê¶Œí•œ ë ˆë²¨

```typescript
interface MenuAuth {
  readAuth: 'Y' | 'N'    // ì¡°íšŒ ê¶Œí•œ
  writeAuth: 'Y' | 'N'   // ë“±ë¡ ê¶Œí•œ
  editAuth: 'Y' | 'N'    // ìˆ˜ì • ê¶Œí•œ
  deleteAuth: 'Y' | 'N'  // ì‚­ì œ ê¶Œí•œ
}
```

---

## 2. ê¶Œí•œ ì²´í¬ íë¦„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. ì‚¬ìš©ì ë¡œê·¸ì¸                                             â”‚
â”‚    â†’ Auth Storeì— user ì •ë³´ ì €ì¥ (userid, role, loginId)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. SidebarMenu ì»´í¬ë„ŒíŠ¸ ë§ˆìš´íŠ¸                               â”‚
â”‚    â†’ loadMenus() í˜¸ì¶œ                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. permissionStore.fetchUserMenus() í˜¸ì¶œ                     â”‚
â”‚    â†’ API: GET /common/menus/users/{loginId}                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. ë©”ë‰´ ê¶Œí•œ ë³‘í•© (mergeMenuPermissions)                     â”‚
â”‚    â†’ ìˆ˜ë™ ë©”ë‰´ + ì„œë²„ ê¶Œí•œ ì •ë³´ = ìµœì¢… ë©”ë‰´                  â”‚
â”‚    â†’ ì„œë²„ ê¶Œí•œ ì—†ìœ¼ë©´ ê¸°ë³¸ê°’: readAuth: 'N' (ë³´ì•ˆ ìš°ì„ )      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. ë©”ë‰´ í•„í„°ë§ (menus computed)                              â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚    â”‚ isFullAccess?                       â”‚                   â”‚
â”‚    â”‚ (SYSTEM_ADMIN, LEADPOWER_MANAGER)   â”‚                   â”‚
â”‚    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                   â”‚
â”‚    â”‚ YES â†’ ì „ì²´ ë©”ë‰´ í‘œì‹œ                â”‚                   â”‚
â”‚    â”‚ NO  â†’ filterMenusByPermission() ì ìš©â”‚                   â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 3. í•µì‹¬ íŒŒì¼ ë° í•¨ìˆ˜

### 3.1 `stores/permission.ts`

| í•¨ìˆ˜/ì†ì„± | ì„¤ëª… |
|-----------|------|
| `fetchUserMenus()` | ì‚¬ìš©ìë³„ ë©”ë‰´ ê¶Œí•œ API í˜¸ì¶œ |
| `isFullAccess` | ì „ì²´ ì ‘ê·¼ ê¶Œí•œ ì—¬ë¶€ (SYSTEM_ADMIN, LEADPOWER_MANAGER) |
| `currentUserRole` | í˜„ì¬ ì‚¬ìš©ì ì—­í•  |
| `hasPermission(menuId, authType)` | íŠ¹ì • ë©”ë‰´ ê¶Œí•œ í™•ì¸ |
| `clearCache()` | ê¶Œí•œ ìºì‹œ ì´ˆê¸°í™” (ëŒ€ë¦¬ ë¡œê·¸ì¸ ì‹œ í•„ìˆ˜) |

### 3.2 `components/admin/SidebarMenu.vue`

| í•¨ìˆ˜ | ì„¤ëª… |
|------|------|
| `loadMenus()` | ë©”ë‰´ ë¡œë“œ ë° ê¶Œí•œ ì ìš© |
| `menus` (computed) | ê¶Œí•œ í•„í„°ë§ëœ ìµœì¢… ë©”ë‰´ ëª©ë¡ |
| `filterMenusByPermission()` | ì¬ê·€ì  ë©”ë‰´ ê¶Œí•œ í•„í„°ë§ |
| `mergeMenuPermissions()` | ìˆ˜ë™ ë©”ë‰´ì™€ ì„œë²„ ê¶Œí•œ ë³‘í•© |

### 3.3 `middleware/auth.ts`

| ê¸°ëŠ¥ | ì„¤ëª… |
|------|------|
| ë¡œê·¸ì¸ ì²´í¬ | ë¹„ë¡œê·¸ì¸ ì‹œ /login ë¦¬ë‹¤ì´ë ‰íŠ¸ |
| ë©”ë‰´ ê¶Œí•œ ì²´í¬ | ê¶Œí•œ ì—†ëŠ” í˜ì´ì§€ ì ‘ê·¼ ì‹œ /admin/unauthorized ë¦¬ë‹¤ì´ë ‰íŠ¸ |

---

## 4. ì—­í• ë³„ ê¶Œí•œ

| ì—­í•  ì½”ë“œ | ì—­í• ëª… | ë©”ë‰´ ì ‘ê·¼ | `isFullAccess` |
|-----------|--------|-----------|----------------|
| SYSTEM_ADMIN | ì‹œìŠ¤í…œ ê´€ë¦¬ì | ì „ì²´ | âœ… true |
| LEADPOWER_MANAGER | ë¦¬ë“œíŒŒì›Œ ë‹´ë‹¹ì | ì „ì²´ | âœ… true |
| OEM_MANAGER | OEM ë‹´ë‹¹ì | ì œí•œì  | âŒ false |
| SITE_MANAGER | ì‹œê³µì‚¬ ë‹´ë‹¹ì | ì œí•œì  | âŒ false |
| SITE_INSPECTOR | ê°ë¦¬ì› | ì œí•œì  | âŒ false |
| SALES_MANAGER | ì˜ì—… ë‹´ë‹¹ì | ì œí•œì  | âŒ false |
| COURIER | ìš´ì†¡ê¸°ì‚¬ | ìµœì†Œ | âŒ false |
| READ_ONLY | ì¡°íšŒ ì „ìš© | ì¡°íšŒë§Œ | âŒ false |

---

## 5. ëŒ€ë¦¬ ë¡œê·¸ì¸ (Impersonation)

### 5.1 íë¦„

```
1. SYSTEM_ADMIN ì‚¬ìš©ìê°€ ëŒ€ë¦¬ ë¡œê·¸ì¸ ìš”ì²­
   â†’ startImpersonation(targetUserId)

2. ì„œë²„ì—ì„œ ëŒ€ìƒ ì‚¬ìš©ì í† í° ë°œê¸‰
   â†’ accessToken, refreshToken êµì²´

3. ì‚¬ìš©ì ì •ë³´ ë³€ê²½
   â†’ authStore.user ì—…ë°ì´íŠ¸

4. ê¶Œí•œ ìºì‹œ ì´ˆê¸°í™”
   â†’ permissionStore.clearCache()

5. SidebarMenuì—ì„œ ì‚¬ìš©ì ë³€ê²½ ê°ì§€
   â†’ loadMenus() ì¬í˜¸ì¶œ

6. ìƒˆ ì‚¬ìš©ì ê¶Œí•œìœ¼ë¡œ ë©”ë‰´ í•„í„°ë§
```

### 5.2 ê´€ë ¨ ì½”ë“œ

```typescript
// stores/auth.ts - startImpersonation()
// ëŒ€ë¦¬ ë¡œê·¸ì¸ í›„ ê¶Œí•œ ìºì‹œ ì´ˆê¸°í™”
const permissionStore = usePermissionStore()
permissionStore.clearCache()

// components/admin/SidebarMenu.vue - watch
watch(
  () => authStore.user,
  (newUser, oldUser) => {
    const userChanged = oldUser && oldUser.userid !== newUser.userid
    if (userChanged) {
      loadMenus()  // ë©”ë‰´ ê¶Œí•œ ì¬ë¡œë“œ
    }
  },
  { deep: true }
)
```

---

## 6. ë””ë²„ê¹… ê°€ì´ë“œ

### 6.1 ì½˜ì†” ë¡œê·¸ í™•ì¸

ë¸Œë¼ìš°ì € ê°œë°œì ë„êµ¬(F12) â†’ Console íƒ­ì—ì„œ í™•ì¸:

```
ğŸ“‹ [loadMenus] ì‹œì‘: {isLoggedIn: true, userid: 5, loginId: 'oem1', role: 'OEM_MANAGER'}
ğŸ“‹ [loadMenus] ì‚¬ìš©ì ë©”ë‰´ ê¶Œí•œ ì¡°íšŒ ì‹œì‘...
ğŸ“‹ [loadMenus] ì„œë²„ ì‘ë‹µ: {menuCount: 10, hasAuth: 'Y', firstMenuAuth: {...}}
ğŸ” [ë©”ë‰´ í•„í„°ë§] ê¶Œí•œ ì²´í¬: {currentRole: 'OEM_MANAGER', isFullAccess: false, ...}
âœ… [ë©”ë‰´ í•„í„°ë§] ê¶Œí•œ ê¸°ë°˜ í•„í„°ë§ ì ìš©
```

### 6.2 ì¼ë°˜ì ì¸ ë¬¸ì œ

| ì¦ìƒ | ì›ì¸ | í•´ê²° |
|------|------|------|
| ëª¨ë“  ë©”ë‰´ê°€ í‘œì‹œë¨ | `isFullAccess: true` | ì—­í•  í™•ì¸ (SYSTEM_ADMIN, LEADPOWER_MANAGERë§Œ ì „ì²´ ì ‘ê·¼) |
| ë©”ë‰´ê°€ ëª¨ë‘ ìˆ¨ê²¨ì§ | API ì‹¤íŒ¨ + ë³´ì•ˆ ìš°ì„  ì •ì±… | ë°±ì—”ë“œ API `/common/menus/users/{loginId}` í™•ì¸ |
| ëŒ€ë¦¬ ë¡œê·¸ì¸ í›„ ë©”ë‰´ ë³€ê²½ ì—†ìŒ | ê¶Œí•œ ìºì‹œ ë¯¸ì´ˆê¸°í™” | `permissionStore.clearCache()` í˜¸ì¶œ í™•ì¸ |
| API ì‘ë‹µ í˜•ì‹ ì˜¤ë¥˜ | `{ success: true, data: [...] }` í˜•ì‹ ë¶ˆì¼ì¹˜ | ë°±ì—”ë“œ ì‘ë‹µ í˜•ì‹ í™•ì¸ |

### 6.3 ìˆ˜ë™ í…ŒìŠ¤íŠ¸

```javascript
// ë¸Œë¼ìš°ì € ì½˜ì†”ì—ì„œ ì‹¤í–‰ ë¶ˆê°€ (Pinia ìŠ¤í† ì–´ ì§ì ‘ ì ‘ê·¼ ì•ˆë¨)
// ëŒ€ì‹  Vue DevTools ì‚¬ìš©:
// 1. Vue DevTools ì„¤ì¹˜
// 2. Components â†’ SidebarMenu ì„ íƒ
// 3. Setup â†’ permissionStore í™•ì¸
```

---

## 7. API ì—°ë™

### 7.1 ì‚¬ìš©ìë³„ ë©”ë‰´ ê¶Œí•œ ì¡°íšŒ

**Endpoint**: `GET /common/menus/users/{loginId}`

**ë°±ì—”ë“œ ì‘ë‹µ** (ë°°ì—´ ì§ì ‘ ë°˜í™˜):
```json
[
  {
    "menuId": 1,
    "menuCode": "SALES",
    "menuName": "ì˜ì—…ê´€ë¦¬",
    "menuUrl": "/admin/sales",
    "menuIcon": "fas fa-chart-line",
    "menuLevel": 1,
    "sortOrder": 1,
    "visible": "Y",
    "useYn": "Y",
    "parentMenuId": null,
    "auth": {
      "readAuth": "Y",
      "writeAuth": "N",
      "editAuth": "N",
      "deleteAuth": "N"
    },
    "children": [
      {
        "menuId": 11,
        "menuCode": "SALES_LIST",
        "menuName": "ì˜ì—…ëª©ë¡",
        "auth": {
          "readAuth": "Y",
          "writeAuth": "N",
          "editAuth": "N",
          "deleteAuth": "N"
        }
      }
    ]
  }
]
```

### 7.2 ì—­í• ë³„ ê¶Œí•œ ì¡°íšŒ/ìˆ˜ì •

| API | ì„¤ëª… |
|-----|------|
| `GET /common/roles` | ì „ì²´ ì—­í•  ëª©ë¡ |
| `GET /common/roles/{roleCode}/permissions` | ì—­í• ë³„ ë©”ë‰´ ê¶Œí•œ |
| `PUT /common/roles/{roleCode}/permissions` | ì—­í• ë³„ ë©”ë‰´ ê¶Œí•œ ì €ì¥ |

---

## 8. ë³´ì•ˆ ì •ì±…

### 8.1 ê¸°ë³¸ê°’: ì ‘ê·¼ ë¶ˆí—ˆ

```typescript
// components/admin/SidebarMenu.vue - filterMenusByPermission()
if (!menu.auth) {
  console.log(`ğŸ”’ [ë©”ë‰´ í•„í„°ë§] auth ì—†ìŒ - ë©”ë‰´ ìˆ¨ê¹€: ${menu.menuName}`)
  return false  // â† ë³´ì•ˆ ìš°ì„ : auth ì—†ìœ¼ë©´ ìˆ¨ê¹€
}

// components/admin/SidebarMenu.vue - mergeMenuPermissions()
auth: serverMenu?.auth || {
  readAuth: 'N',   // â† ë³´ì•ˆ ìš°ì„ : ê¸°ë³¸ê°’ ì ‘ê·¼ ë¶ˆí—ˆ
  writeAuth: 'N',
  editAuth: 'N',
  deleteAuth: 'N'
}
```

### 8.2 ê´€ë¦¬ì ì˜ˆì™¸ ì²˜ë¦¬

```typescript
// components/admin/SidebarMenu.vue - menus computed
const menus = computed(() => {
  // ì „ì²´ ì ‘ê·¼ ê¶Œí•œì´ ìˆìœ¼ë©´ í•„í„°ë§ ì—†ì´ ëª¨ë‘ í‘œì‹œ
  if (permissionStore.isFullAccess) {
    return rawMenus.value  // â† SYSTEM_ADMIN, LEADPOWER_MANAGER
  }
  // ê¶Œí•œ ê¸°ë°˜ í•„í„°ë§
  return filterMenusByPermission(rawMenus.value)
})
```

---

## 9. ë³€ê²½ ì´ë ¥

| ë‚ ì§œ | ë³€ê²½ ë‚´ìš© | ë‹´ë‹¹ì |
|------|-----------|--------|
| 2025-12-28 | ë³´ì•ˆ ìš°ì„  ì •ì±… ì ìš© (auth ì—†ìœ¼ë©´ ìˆ¨ê¹€) | Claude |
| 2025-12-28 | ëŒ€ë¦¬ ë¡œê·¸ì¸ ì‹œ ê¶Œí•œ ìºì‹œ ì´ˆê¸°í™” ì¶”ê°€ | Claude |
| 2025-12-28 | ë””ë²„ê¹… ë¡œê·¸ ì¶”ê°€ | Claude |
