# 출하관리 시스템 V2 - 프론트엔드 PRD

> 작성일: 2025-12-09
> 버전: 2.6
> 대상: 프론트엔드 개발자
> 변경이력:
>   - v2.6 - 주문 상태 추적 시스템 추가 (부록 D), 변경계약 처리 로직 보완
>   - v2.5 - 출하 수량 추가변경 기능 상세 추가 (3.10절)
>   - v2.4 - 주문 등록/수정 화면 계약 유형 선택 UI 상세 추가 (3.6절)
>   - v2.3 - 추가분 계약 유형 UI 상세화 (변경/별도계약 처리)
> 관련 문서: [백엔드 PRD](../../ptlpsmback/docs/FEATURE_REQUIREMENTS_V2.md)

---

## 목차

1. [개요](#1-개요)
2. [신규 화면 목록](#2-신규-화면-목록)
3. [화면별 상세 명세](#3-화면별-상세-명세)
4. [공통 컴포넌트](#4-공통-컴포넌트)
5. [API 연동](#5-api-연동)
6. [상태 관리 (Store)](#6-상태-관리-store)
7. [구현 우선순위](#7-구현-우선순위)

---

## 1. 개요

### 1.1 V2 주요 기능

| 기능 | 설명 | 신규 화면 |
|------|------|----------|
| 자금 관리 | 선급금/기성금/잔금 통합 관리 | 자금관리 목록, 상세, 대시보드 |
| 기성/납품확인 차수 | 기성 청구 및 납품완료 시 스냅샷 관리 | 기성 청구 모달, 차수 목록 |
| 품목 원가 | OEM 계약 단가 관리 | 품목관리 화면 수정 |
| 수량 변경 이력 | 출하 수량 변경 추적 | 이력 조회 모달 |
| 모바일 주문 요청 | 현장소장 주문 요청 | 요청 목록, 상세, 승인 |

### 1.2 핵심 비즈니스 개념 (UI 구현 시 참고)

#### 분할납품요구서
- **수요기관이 조달청 시스템에 등록**하여 발급받는 문서 (출하관리 시스템은 등록/관리만)
- 번호 체계: `35-24-3-41787-00` (00=기준, 01/02...=추가분)
- 납품요구번호는 **조달청 시스템에서 자동 부여**
- UI에서 번호 입력 시 자동 파싱하여 기준번호와 순번 분리

**추가 납품 처리 방식:**
- **소량 추가**: 분할납품요구서 없이 기존 출하 수량만 변경 (수량 변경 이력 기록)
- **일정 기준 초과**: 수요기관과 협의 후 조달청에 분할납품요구서 등록 요청 → 새 번호 발급
- 발급 여부 및 시점은 **수요기관과의 협의에 의해** 결정

#### 추가분 계약 유형 (⭐ 중요)

분할납품요구서 추가분(01, 02...)은 **계약 유형**에 따라 두 가지로 구분됩니다:

| 구분 | 변경계약 (AMENDMENT) | 별도계약 (SEPARATE) |
|------|------------------------|------------------------|
| **의미** | 기존 계약의 수정/추가 | 완전히 새로운 별도 계약 |
| **발생 사유** | 계약 변경으로 수량/금액 변경 | 추가 발주로 별도 계약 체결 |
| **계약서** | 기존 계약서에 변경 조항 추가 | 새로운 계약서 발급 |
| **자금 관리** | 기준 계약과 **합산** 관리 | **별도** 자금 관리 |
| **기성 청구** | 기준 계약에 포함하여 청구 | 별도로 기성 청구 |
| **납품완료** | 기준 계약과 함께 완료 처리 | 별도로 납품완료 처리 |
| **번호 체계** | 35-24-3-41787-**01** | 35-24-3-41787-**01** (동일) |

> ⚠️ **핵심 포인트:** 분할납품요구서 번호 체계는 동일하지만, 계약 유형에 따라 **자금 관리 방식이 완전히 다릅니다.**

##### 변경계약 (AMENDMENT) UI 처리

- 기준 계약의 **fund_id 공유** → 자금 관리 화면에서 통합 표시
- 기성 청구 시 **기준계약 + 변경계약 품목 함께 표시**
- 하나의 납품확인서로 통합 청구
- 납품완료도 기준 계약과 함께 처리

##### 변경계약 PDF 등록 시 데이터 처리

1. **Orders 테이블**: 기준 납품요구번호는 유지, 카운트 번호만 증가하여 새 레코드 추가
   - 예: `35-24-3-41787-00` → `35-24-3-41787-01`
2. **DeliveryDone 테이블**: 수량 업데이트 (출하 진행 중/서명 완료 상태에서도 허용)
3. **출하 처리**: 기존 출하 수정 또는 추가 출하 생성 선택 가능

> ⚠️ **출하/서명 진행 중 변경계약 시**: 추가 수량이 반영되며, `delivery_done` 수량이 자동 업데이트됩니다.

##### 별도계약 (SEPARATE) UI 처리

- **별도 fund_id 생성** → 독립적인 자금 관리 화면
- 기성 청구 시 **별도계약 품목만 별도 청구**
- 독립적인 납품확인서 생성
- 별도로 납품완료 처리
- 기준계약과 별도의 기성 차수 관리 (각각 기성 1차, 2차...)

**주문 목록 UI 표시:**
```
┌────────────────────────────────────────────────────────────────────────────────┐
│ 납품요구번호     │ 순번 │ 계약유형           │ 현장명      │ 계약금액    │ 자금   │
├────────────────────────────────────────────────────────────────────────────────┤
│ 35-24-3-41787-00 │ [00] │ 파란색 [기준]        │ ○○아파트   │ 50,000,000 │ 통합   │
│ 35-24-3-41787-01 │ [01] │ 파란색 [변경] 하늘색배경│ ○○아파트   │ 10,000,000 │ ↑합산  │
│ 35-24-3-41787-02 │ [02] │ 주황색 [별도] 주황색배경│ ○○아파트   │ 20,000,000 │ 별도   │
└────────────────────────────────────────────────────────────────────────────────┘

배지 색상:
- 기준(ORIGINAL): 파란색 bg-blue-100 text-blue-800
- 변경(AMENDMENT): 하늘색 bg-sky-100 text-sky-800
- 별도(SEPARATE): 주황색 bg-orange-100 text-orange-800
```

**자금 관리 화면 표시:**
```
┌──────────────────────────────────────────────────────────────────────┐
│ 자금 관리 목록                                                          │
├──────────────────────────────────────────────────────────────────────┤
│ 납품요구번호 │ 현장명   │ 계약유형 │ 계약금액    │ 수금액    │ 상태 │
├──────────────────────────────────────────────────────────────────────┤
│ 35-24-3-41787 │ ○○아파트 │ 통합     │ 60,000,000 │ 42,000,000│ 진행 │
│   └ 00+01 통합│          │ (변경포함)│            │          │      │
│               │          │          │            │          │      │
│ 35-24-3-41787 │ ○○아파트 │ 별도     │ 20,000,000 │ 14,000,000│ 진행 │
│   └ 02 별도    │          │          │            │          │      │
└──────────────────────────────────────────────────────────────────────┘

설명:
- 기준(00) + 변경(01) = 통합하여 1개의 자금 레코드로 표시
- 별도(02) = 독립적인 자금 레코드로 별도 표시
```

#### 자금 흐름
```
선급금 (계약 시) → 기성금 (중간 정산, 여러 번) → 잔금 (최종)
```

#### 기성/납품확인 차수 (용어 정의)

| 용어 | 설명 | UI 표시 |
|------|------|---------|
| **기성 1차, 2차...** | 중간 정산을 위한 기성금 청구 차수 | "기성 1차", "기성 2차" |
| **납품완료** | 최종 납품 완료 후 잔금 청구 | "납품완료" |
| **차수 스냅샷** | 해당 차수 시점의 수량/단가 확정 데이터 | - |

**왜 차수(스냅샷)가 필요한가?**
- 기성 청구 시 "그 시점 수량/단가"를 스냅샷으로 저장
- 나중에 원본 출하 수량이 바뀌어도 스냅샷은 유지
- 기성금 청구 근거는 변하지 않음
- 기성 청구 및 납품완료 시 **납품확인서 필수 생성**

#### ⚠️ 기성 확정 후 수량 변경 처리 (중요)

기성 확정 후에도 출하 수량 변경이 발생할 수 있습니다 (파손, 부족, 추가 요청 등). 이 경우의 처리 로직:

**시나리오 예시:**
```
[기성 1차 확정]
- 출하 1: 30개, 출하 2: 40개
- 합계 70개 → 기성 1차 확정 (스냅샷 저장)

[기성 1차 확정 후 변경 발생]
- 출하 2: 파손 5개 추가 → 40개 → 45개로 변경 (수량 변경 이력 기록)
- 출하 3 추가: 20개
- 현재 실제 납품 수량: 30 + 45 + 20 = 95개

[기성 2차 청구 시]
- 이전 확정 수량: 70개 (스냅샷, 변경 불가)
- 현재 납품 수량: 95개
- 이번 청구 수량: 95 - 70 = 25개 ← 변경분 5개 + 신규 출하 20개
```

**핵심 규칙:**
1. **기성 확정된 수량은 절대 변경 불가** - 스냅샷으로 고정
2. **확정 후 수량 변경분은 다음 차수에서 자동 반영** - this_time_quantity에 포함
3. **수량 변경 시 반드시 이력 기록** - 변경 사유 필수 입력

**UI 처리:**
- 기성 청구 모달에서 "이전 확정 수량" vs "현재 납품 수량" 비교 표시
- 변경분이 있는 경우 안내 메시지 표시
- 수량 변경 이력 조회 버튼 제공

**계산식:**
```
this_time_quantity = 현재_납품수량 - 이전_차수_확정수량

// 변경분이 포함된 예시
이번_청구_수량(25) = 현재_납품(95) - 이전_확정(70)
                   = (30+45+20) - (30+40)
                   = 변경분(5) + 신규출하(20)
```

---

## 2. 신규 화면 목록

### 2.1 화면 구조

```
pages/
├── admin/
│   ├── funds/                    # 자금 관리 (신규)
│   │   ├── index.vue            # 자금 관리 목록
│   │   ├── [id].vue             # 자금 관리 상세
│   │   └── statistics.vue       # 자금 통계 대시보드
│   │
│   ├── items/
│   │   └── index.vue            # 품목 관리 (수정: 원가 컬럼 추가)
│   │
│   ├── orders/
│   │   ├── index.vue            # 주문 목록 (수정: 분할번호 표시)
│   │   └── [id].vue             # 주문 상세 (수정: 기성/납품확인 탭 추가)
│   │
│   └── order-requests/           # 모바일 주문 요청 관리 (신규)
│       └── index.vue            # 요청 목록 및 승인
│
└── mobile/
    └── order-requests/           # 모바일 주문 요청 (신규)
        ├── index.vue            # 요청 목록 (본인 것)
        └── new.vue              # 신규 요청 작성
```

### 2.2 화면별 역할/권한

| 화면 | 허용 역할 | 설명 |
|------|----------|------|
| /admin/funds/* | SYSTEM_ADMIN, LEADPOWER_MANAGER | 자금 관리 전체 |
| /admin/items (원가) | SYSTEM_ADMIN, LEADPOWER_MANAGER | 원가 수정 권한 |
| /admin/order-requests | SYSTEM_ADMIN, LEADPOWER_MANAGER | 주문 요청 승인 |
| /mobile/order-requests | SITE_SUPERVISOR | 모바일 주문 요청 |

---

## 3. 화면별 상세 명세

### 3.1 자금 관리 목록 (`/admin/funds`)

#### 화면 레이아웃

```
┌─────────────────────────────────────────────────────────────────────────┐
│ 🏦 자금 관리                                            [+ 신규 등록]    │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│ [검색 필터]                                                               │
│ ┌──────────────┐ ┌──────────────┐ ┌──────────────┐ ┌────────┐          │
│ │ 납품요구번호  │ │ 현장명       │ │ 상태 ▼      │ │ 검색   │          │
│ └──────────────┘ └──────────────┘ └──────────────┘ └────────┘          │
│                                                                          │
│ [요약 카드]                                                               │
│ ┌───────────────┐ ┌───────────────┐ ┌───────────────┐ ┌───────────────┐│
│ │ 📊 총 계약금액 │ │ 💰 수금 누계  │ │ 📋 미수금     │ │ 📈 현재 수익  ││
│ │ ₩150,000,000  │ │ ₩95,000,000  │ │ ₩55,000,000  │ │ ₩23,000,000  ││
│ └───────────────┘ └───────────────┘ └───────────────┘ └───────────────┘│
│                                                                          │
│ [목록 테이블]                                                             │
│ ┌────────────────────────────────────────────────────────────────────┐  │
│ │ □ │납품요구번호  │현장명      │계약금액    │수금액     │상태│액션│  │
│ ├────────────────────────────────────────────────────────────────────┤  │
│ │ □ │35-24-3-41787│○○아파트   │50,000,000 │35,000,000│진행│상세│  │
│ │ □ │35-24-3-41788│△△빌딩    │80,000,000 │60,000,000│진행│상세│  │
│ │ □ │35-24-3-41789│□□주택    │20,000,000 │20,000,000│완료│상세│  │
│ └────────────────────────────────────────────────────────────────────┘  │
│                                                                          │
│ [페이지네이션]  < 1 2 3 4 5 >                                             │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

#### 테이블 컬럼 정의

| 컬럼 | 필드명 | 타입 | 정렬 | 설명 |
|------|--------|------|------|------|
| 선택 | - | checkbox | - | 다중 선택 |
| 납품요구번호 | deliveryRequestNo | string | ✓ | 클릭 시 상세 이동 |
| 현장명 | siteName | string | ✓ | - |
| 계약금액 | contractTotalAmount | currency | ✓ | 원화 포맷 |
| 선급금 | advancePaymentAmount | currency | - | - |
| 기성금 누계 | progressPaymentTotal | currency | - | - |
| 잔금 | balanceAmount | currency | - | 자동 계산 |
| 상태 | status | badge | ✓ | ACTIVE/COMPLETED/CANCELLED |
| 액션 | - | button | - | 상세 버튼 |

---

### 3.2 자금 관리 상세 (`/admin/funds/[id]`)

#### 화면 레이아웃

```
┌─────────────────────────────────────────────────────────────────────────┐
│ ← 목록으로  자금 관리 상세                                    [수정] [삭제]│
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│ [기본 정보 카드]                                                          │
│ ┌────────────────────────────────────────────────────────────────────┐  │
│ │ 납품요구번호: 35-24-3-41787-00        현장명: ○○아파트 신축공사     │  │
│ │ 시공사: (주)○○건설                   계약일: 2024-10-15            │  │
│ └────────────────────────────────────────────────────────────────────┘  │
│                                                                          │
│ [자금 현황 요약]                                                          │
│ ┌──────────────┐ ┌──────────────┐ ┌──────────────┐ ┌──────────────┐    │
│ │ 계약총액      │ │ 선급금       │ │ 기성금 누계   │ │ 잔금         │    │
│ │ ₩50,000,000  │ │ ₩5,000,000  │ │ ₩30,000,000 │ │ ₩15,000,000 │    │
│ │              │ │ (10%)       │ │ (60%)       │ │ (30%)       │    │
│ └──────────────┘ └──────────────┘ └──────────────┘ └──────────────┘    │
│                                                                          │
│ [프로그레스 바]                                                           │
│ ████████████████████████████████████░░░░░░░░░░░░░░░░░░  70% 수금        │
│                                                                          │
│ [탭 메뉴]                                                                 │
│ ┌────────┬────────┬────────┬────────┬────────┐                          │
│ │ 선급금 │ 기성금 │ 잔금   │ OEM지급│ 이력   │                          │
│ └────────┴────────┴────────┴────────┴────────┘                          │
│                                                                          │
│ [기성금 탭 내용]                                                          │
│ ┌─────────────────────────────────────────────────────────────────────┐ │
│ │                                              [+ 기성 청구하기]       │ │
│ ├─────────────────────────────────────────────────────────────────────┤ │
│ │ 차수     │ 유형 │ 확정일  │ 납품수량│ 청구금액  │납품확인서│ 상태│액션│ │
│ ├─────────────────────────────────────────────────────────────────────┤ │
│ │ 기성 1차 │ 중간 │ 11/01  │ 70개   │ 35,000,000│ 📄 보기 │ 입금│상세│ │
│ │ 기성 2차 │ 중간 │ 12/01  │ 15개   │ 7,500,000 │ 📄 보기 │ 승인│상세│ │
│ │ 납품완료 │ 최종 │ -      │ 15개   │ 7,500,000 │ -      │ 대기│상세│ │
│ └─────────────────────────────────────────────────────────────────────┘ │
│                                                                          │
│ 합계: 주문 100개 중 85개 확정 (85%)  /  청구 누계: ₩42,500,000           │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

#### 탭별 내용

**1. 선급금 탭**
```
┌────────────────────────────────────────────────────────────────────┐
│ 선급금 정보                                           [수정]        │
├────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  선급금 비율: 10%                                                    │
│  선급금 금액: ₩5,000,000                                            │
│  수령일: 2024-10-20                                                 │
│  비고: -                                                            │
│                                                                     │
└────────────────────────────────────────────────────────────────────┘
```

**2. 기성금 탭** (위 레이아웃 참조)

**3. 잔금 탭**
```
┌────────────────────────────────────────────────────────────────────┐
│ 잔금 정보                                                           │
├────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  잔금 예정액: ₩15,000,000                                           │
│  계산식: 계약총액(50M) - 선급금(5M) - 기성금누계(30M)                  │
│                                                                     │
│  [납품완료 처리하기] 버튼 (납품 완료 후 활성화)                        │
│                                                                     │
└────────────────────────────────────────────────────────────────────┘
```

**4. OEM 지급 탭**
```
┌────────────────────────────────────────────────────────────────────┐
│ OEM 지급 현황                                     [+ 지급 등록]      │
├────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  총 지급액: ₩22,000,000 / 예상 총액: ₩35,000,000                    │
│                                                                     │
│ ┌──────────────────────────────────────────────────────────────┐   │
│ │ 지급일     │ 연관 차수 │ 금액       │ 유형   │ 비고            │   │
│ ├──────────────────────────────────────────────────────────────┤   │
│ │ 2024-11-05│ 기성 1차 │ 12,000,000│ 기성금 │ -               │   │
│ │ 2024-12-05│ 기성 2차 │ 10,000,000│ 기성금 │ -               │   │
│ └──────────────────────────────────────────────────────────────┘   │
│                                                                     │
└────────────────────────────────────────────────────────────────────┘
```

---

### 3.3 기성 청구 모달

기성 청구 모달은 **이전 차수 확정 후 수량 변경 여부**에 따라 다른 UI를 표시합니다.

#### 3.3.1 기본 레이아웃 (변경분 없는 경우)

```
┌─────────────────────────────────────────────────────────────────────────┐
│ 기성 2차 청구                                                      [X]   │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  납품요구번호: 35-24-3-41787-00                                          │
│  이전 차수: 기성 1차 (2024-11-01, 70개 확정)                              │
│                                                                          │
│  ─────────────────────────────────────────────────────────────────────  │
│                                                                          │
│  [품목별 현황]                                                            │
│  ┌──────────────────────────────────────────────────────────────────┐   │
│  │ 품목       │ 주문 │ 이전확정 │ 현재납품 │ 이번청구 │ 금액          │   │
│  ├──────────────────────────────────────────────────────────────────┤   │
│  │ 가로등 A형 │ 60  │ 40      │ 50      │ 10      │ 5,000,000     │   │
│  │ 가로등 B형 │ 40  │ 30      │ 35      │ 5       │ 2,500,000     │   │
│  │ 볼라드    │ 50  │ 0       │ 0       │ 0       │ 0             │   │
│  └──────────────────────────────────────────────────────────────────┘   │
│                                                                          │
│  [자동 계산 결과]                                                         │
│  ┌─────────────────────┐  ┌─────────────────────┐                       │
│  │ 이번 차수 청구 금액   │  │ OEM 지급 예정 금액   │                       │
│  │ ₩7,500,000         │  │ ₩5,250,000         │                       │
│  │ (이전 대비 +15개)   │  │ (원가 기준)         │                       │
│  └─────────────────────┘  └─────────────────────┘                       │
│                                                                          │
│  ☑ 납품확인서 자동 생성 (필수)                                             │
│                                                                          │
│  ⚠️ 기성 청구 시 현재 수량과 단가가 스냅샷으로 저장됩니다.                   │
│     이후 원본 데이터가 변경되어도 청구 근거는 유지됩니다.                     │
│                                                                          │
│             [취소]                    [기성 2차 청구하기]                   │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

#### 3.3.2 변경분 포함 레이아웃 (⭐ 중요)

이전 차수 확정 후 출하 수량이 변경된 경우, 변경 내역을 명확히 표시합니다.

```
┌─────────────────────────────────────────────────────────────────────────┐
│ 기성 2차 청구                                                      [X]   │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  납품요구번호: 35-24-3-41787-00                                          │
│  이전 차수: 기성 1차 (2024-11-01, 70개 확정)                              │
│                                                                          │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │ ⚠️ 기성 1차 확정 후 수량 변경이 있습니다                          │    │
│  │                                                                  │    │
│  │   • 출하 #2 (2024-10-20): 40개 → 45개 (+5개, 파손 보충)          │    │
│  │   • 출하 #3 (2024-11-15): 신규 20개                              │    │
│  │                                                                  │    │
│  │   📊 변경분 5개는 이번 기성 2차 청구에 자동 포함됩니다.            │    │
│  │                                                                  │    │
│  │                                    [수량 변경 이력 상세보기]      │    │
│  └─────────────────────────────────────────────────────────────────┘    │
│                                                                          │
│  ─────────────────────────────────────────────────────────────────────  │
│                                                                          │
│  [품목별 현황]                                                            │
│  ┌───────────────────────────────────────────────────────────────────┐  │
│  │ 품목      │주문│이전확정│ 현재납품  │ 이번청구      │ 금액        │  │
│  ├───────────────────────────────────────────────────────────────────┤  │
│  │ 가로등 A형│ 60│   40  │   55     │ 15           │ 7,500,000  │  │
│  │          │   │       │(변경+5)  │ (신규10+변경5)│ ↑변경분포함 │  │
│  ├───────────────────────────────────────────────────────────────────┤  │
│  │ 가로등 B형│ 40│   30  │   40     │ 10           │ 5,000,000  │  │
│  │ 볼라드   │ 50│    0  │    0     │  0           │ 0          │  │
│  └───────────────────────────────────────────────────────────────────┘  │
│                                                                          │
│  [이번 청구 수량 분석]                                                    │
│  ┌───────────────────────────────────────────────────────────────────┐  │
│  │                                                                    │  │
│  │   신규 출하분:        20개    ₩10,000,000                         │  │
│  │   이전 확정 후 변경분:  5개     ₩2,500,000  ← 기성1차 이후 추가분   │  │
│  │   ─────────────────────────────────────                           │  │
│  │   합계:               25개    ₩12,500,000                         │  │
│  │                                                                    │  │
│  └───────────────────────────────────────────────────────────────────┘  │
│                                                                          │
│  [자동 계산 결과]                                                         │
│  ┌─────────────────────┐  ┌─────────────────────┐                       │
│  │ 이번 차수 청구 금액   │  │ OEM 지급 예정 금액   │                       │
│  │ ₩12,500,000        │  │ ₩8,750,000         │                       │
│  │ (25개: 신규20+변경5)│  │ (원가 기준)         │                       │
│  └─────────────────────┘  └─────────────────────┘                       │
│                                                                          │
│  ☑ 납품확인서 자동 생성 (필수)                                             │
│                                                                          │
│  ⚠️ 기성 청구 시 현재 수량과 단가가 스냅샷으로 저장됩니다.                   │
│     이후 원본 데이터가 변경되어도 청구 근거는 유지됩니다.                     │
│                                                                          │
│             [취소]                    [기성 2차 청구하기]                   │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

#### 3.3.3 수량 변경 이력 상세 모달

"수량 변경 이력 상세보기" 클릭 시 표시되는 하위 모달:

```
┌─────────────────────────────────────────────────────────────────────────┐
│ 수량 변경 이력                                                     [X]   │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  납품요구번호: 35-24-3-41787-00                                          │
│  조회 기간: 기성 1차 확정일 (2024-11-01) 이후                             │
│                                                                          │
│  ─────────────────────────────────────────────────────────────────────  │
│                                                                          │
│  [변경 이력 목록]                                                         │
│  ┌───────────────────────────────────────────────────────────────────┐  │
│  │ 일시            │출하 │품목     │변경전│변경후│차이│변경사유      │  │
│  ├───────────────────────────────────────────────────────────────────┤  │
│  │ 2024-11-05 14:30│ #2 │가로등A형│ 40  │ 43  │ +3│현장 파손 보충  │  │
│  │ 2024-11-08 09:15│ #2 │가로등A형│ 43  │ 45  │ +2│추가 요청      │  │
│  │ 2024-11-15 10:00│ #3 │가로등A형│ -   │ 10  │+10│신규 출하      │  │
│  │ 2024-11-15 10:00│ #3 │가로등B형│ -   │ 10  │+10│신규 출하      │  │
│  └───────────────────────────────────────────────────────────────────┘  │
│                                                                          │
│  [품목별 변경 요약]                                                       │
│  ┌───────────────────────────────────────────────────────────────────┐  │
│  │ 품목       │ 기성1차 확정 │ 현재 수량 │ 변경분 합계 │ 비고          │  │
│  ├───────────────────────────────────────────────────────────────────┤  │
│  │ 가로등 A형 │     40개    │   55개   │    +15개   │ 보충5+신규10  │  │
│  │ 가로등 B형 │     30개    │   40개   │    +10개   │ 신규10        │  │
│  │ 볼라드    │      0개    │    0개   │      0개   │ -             │  │
│  └───────────────────────────────────────────────────────────────────┘  │
│                                                                          │
│  📊 총 변경분: 25개 (이번 기성 2차 청구에 모두 포함)                        │
│                                                                          │
│                                                        [닫기]            │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

#### 3.3.4 첫 번째 기성 청구 (기성 1차)

이전 차수가 없는 첫 기성 청구의 경우:

```
┌─────────────────────────────────────────────────────────────────────────┐
│ 기성 1차 청구                                                      [X]   │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  납품요구번호: 35-24-3-41787-00                                          │
│  이전 차수: 없음 (최초 기성 청구)                                         │
│                                                                          │
│  ─────────────────────────────────────────────────────────────────────  │
│                                                                          │
│  [품목별 현재 납품 현황]                                                  │
│  ┌──────────────────────────────────────────────────────────────────┐   │
│  │ 품목       │ 주문수량 │ 현재 납품 │ 이번 청구 │ 잔여     │ 금액    │   │
│  ├──────────────────────────────────────────────────────────────────┤   │
│  │ 가로등 A형 │    60   │    40    │    40    │   20    │20,000,000│   │
│  │ 가로등 B형 │    40   │    30    │    30    │   10    │15,000,000│   │
│  │ 볼라드    │    50   │     0    │     0    │   50    │ 0        │   │
│  └──────────────────────────────────────────────────────────────────┘   │
│                                                                          │
│  [자동 계산 결과]                                                         │
│  ┌─────────────────────┐  ┌─────────────────────┐                       │
│  │ 이번 차수 청구 금액   │  │ OEM 지급 예정 금액   │                       │
│  │ ₩35,000,000        │  │ ₩24,500,000        │                       │
│  │ (70개)             │  │ (원가 기준)         │                       │
│  └─────────────────────┘  └─────────────────────┘                       │
│                                                                          │
│  ☑ 납품확인서 자동 생성 (필수)                                             │
│                                                                          │
│  ⚠️ 기성 청구 시 현재 수량과 단가가 스냅샷으로 저장됩니다.                   │
│     이후 원본 데이터가 변경되어도 청구 근거는 유지됩니다.                     │
│                                                                          │
│             [취소]                    [기성 1차 청구하기]                   │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

#### 3.3.5 주요 기능 및 처리 로직

**1. 모달 오픈 시 데이터 로드**
```typescript
const loadBaselineData = async (orderId: number) => {
  // 1. 이전 차수 정보 조회
  const previousBaseline = await api.getLatestBaseline(orderId);
  
  // 2. 현재 출하/납품 수량 조회
  const currentQuantities = await api.getCurrentQuantities(orderId);
  
  // 3. 이전 차수 이후 수량 변경 이력 조회
  const quantityChanges = previousBaseline 
    ? await api.getQuantityChanges(orderId, previousBaseline.baselineDate)
    : [];
  
  // 4. 변경분 계산
  const hasChanges = quantityChanges.length > 0;
  const changesSummary = calculateChangesSummary(quantityChanges);
  
  return { previousBaseline, currentQuantities, quantityChanges, hasChanges, changesSummary };
};
```

**2. 이번 청구 수량 계산**
```typescript
const calculateThisTimeQuantity = (item: ItemData) => {
  const previousConfirmed = previousBaseline?.items.find(i => i.itemId === item.itemId)?.deliveredQuantity || 0;
  const currentDelivered = item.currentDeliveredQuantity;
  
  return {
    thisTimeQuantity: currentDelivered - previousConfirmed,
    thisTimeAmount: (currentDelivered - previousConfirmed) * item.unitPrice,
    thisTimeCost: (currentDelivered - previousConfirmed) * item.costPrice,
    // 변경분 분석
    fromNewShipments: getNewShipmentQuantity(item.itemId),  // 신규 출하분
    fromModifications: getModificationQuantity(item.itemId), // 기존 출하 수정분
  };
};
```

**3. 변경분 표시 조건**
```typescript
const shouldShowChangesAlert = computed(() => {
  // 이전 차수가 있고, 그 이후 수량 변경이 있는 경우
  return previousBaseline !== null && quantityChanges.length > 0;
});

const changesAlertType = computed(() => {
  // 변경분 유형에 따른 알림 스타일
  if (hasDecrease) return 'warning';  // 수량 감소가 있는 경우
  return 'info';  // 수량 증가만 있는 경우
});
```

**4. 기성 청구 확정 처리**
```typescript
const submitProgressPayment = async () => {
  // 확인 다이얼로그
  const confirmed = await confirm({
    title: `기성 ${nextSeq}차 청구 확정`,
    message: `현재 수량과 단가로 기성 ${nextSeq}차를 확정합니다.\n확정 후에는 수정할 수 없습니다.`,
    confirmText: '확정하기',
    cancelText: '취소'
  });
  
  if (!confirmed) return;
  
  // API 호출 - 스냅샷 생성 + 납품확인서 생성
  const result = await api.createBaseline(orderId, {
    baselineType: 'PROGRESS',
    remarks: remarks.value
  });
  
  // 성공 처리
  toast.success(`기성 ${nextSeq}차가 확정되었습니다.`);
  emit('created', result);
  closeModal();
};
```

**5. 유효성 검사**
```typescript
const validationErrors = computed(() => {
  const errors: string[] = [];
  
  // 청구할 수량이 없는 경우
  if (totalThisTimeQuantity.value === 0) {
    errors.push('청구할 수량이 없습니다. 출하/납품 내역을 확인해주세요.');
  }
  
  // 납품 수량이 주문 수량을 초과하는 경우
  if (hasOverDelivery.value) {
    errors.push('일부 품목의 납품 수량이 주문 수량을 초과합니다.');
  }
  
  return errors;
});

const canSubmit = computed(() => validationErrors.value.length === 0);
```

#### 3.3.6 컴포넌트 Props/Emits

```typescript
// components/fund/ProgressPaymentModal.vue

interface Props {
  orderId: number;
  isOpen: boolean;
}

interface Emits {
  (e: 'close'): void;
  (e: 'created', baseline: Baseline): void;
}

// 내부 상태
interface State {
  loading: boolean;
  previousBaseline: Baseline | null;
  currentQuantities: CurrentQuantitySnapshot;
  quantityChanges: QuantityChangeRecord[];
  items: ProgressPaymentItem[];
  remarks: string;
}

interface ProgressPaymentItem {
  itemId: number;
  itemName: string;
  specification: string;
  unit: string;
  unitPrice: number;
  costPrice: number;
  orderedQuantity: number;
  previousConfirmed: number;      // 이전 차수 확정 수량
  currentDelivered: number;       // 현재 납품 수량
  thisTimeQuantity: number;       // 이번 청구 수량
  thisTimeAmount: number;         // 이번 청구 금액
  thisTimeCost: number;           // 이번 OEM 비용
  fromNewShipments: number;       // 신규 출하분
  fromModifications: number;      // 기존 출하 수정분
  hasModification: boolean;       // 수정분 포함 여부
}
```

#### 3.3.7 API 연동

| 메서드 | 엔드포인트 | 설명 |
|--------|-----------|------|
| GET | `/admin/orders/{orderId}/baselines/latest` | 최신 차수 조회 |
| GET | `/admin/orders/{orderId}/current-quantities` | 현재 출하/납품 수량 조회 |
| GET | `/admin/orders/{orderId}/quantity-changes?since={date}` | 특정일 이후 수량 변경 이력 |
| POST | `/admin/orders/{orderId}/baselines` | 기성/납품완료 차수 생성 |

---

### 3.4 납품완료 처리 모달

```
┌─────────────────────────────────────────────────────────────────────────┐
│ 납품완료 처리                                                      [X]   │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  납품요구번호: 35-24-3-41787-00                                          │
│  이전 차수: 기성 2차 (2024-12-01, 85개 확정)                              │
│                                                                          │
│  ─────────────────────────────────────────────────────────────────────  │
│                                                                          │
│  [품목별 최종 현황]                                                       │
│  ┌──────────────────────────────────────────────────────────────────┐   │
│  │ 품목       │ 주문 │ 이전확정 │ 현재납품 │ 이번청구 │ 잔고          │   │
│  ├──────────────────────────────────────────────────────────────────┤   │
│  │ 가로등 A형 │ 60  │ 50      │ 60      │ 10      │ 0             │   │
│  │ 가로등 B형 │ 40  │ 35      │ 40      │ 5       │ 0             │   │
│  │ 볼라드    │ 50  │ 0       │ 50      │ 50      │ 0             │   │
│  └──────────────────────────────────────────────────────────────────┘   │
│                                                                          │
│  [잔금 계산]                                                              │
│  ┌─────────────────────┐  ┌─────────────────────┐                       │
│  │ 잔금 청구 금액       │  │ OEM 최종 지급 금액   │                       │
│  │ ₩7,500,000         │  │ ₩5,250,000         │                       │
│  └─────────────────────┘  └─────────────────────┘                       │
│                                                                          │
│  ☑ 납품확인서(납품완료계) 자동 생성 (필수)                                  │
│                                                                          │
│  ⚠️ 납품완료 처리 시 최종 수량이 확정되며, 이후 수정이 불가능합니다.          │
│                                                                          │
│             [취소]                    [납품완료 처리하기]                   │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

---

### 3.5 품목 관리 수정 (`/admin/items`)

#### 변경 사항

**추가 컬럼:**
| 컬럼 | 필드명 | 타입 | 권한 | 설명 |
|------|--------|------|------|------|
| 원가 | costPrice | currency | 관리자만 수정 | OEM 계약 단가 |
| 마진율 | marginRate | percentage | - | 자동계산: (납품단가-원가)/납품단가 × 100 |

**UI 변경:**
```
┌────────────────────────────────────────────────────────────────────┐
│ ... 기존 컬럼들 ... │ 납품단가 │ 원가     │ 마진율 │ ... │
├────────────────────────────────────────────────────────────────────┤
│                     │ 50,000  │ 35,000  │ 30%   │     │
│                     │ 80,000  │ [수정]  │ -     │     │  ← 원가 미입력 시
└────────────────────────────────────────────────────────────────────┘
```

**원가 수정 모달:**
```
┌─────────────────────────────────────────────────────────────┐
│ 원가 수정                                              [X]   │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  품목명: 가로등 A형 (LP-A001)                                 │
│  현재 납품단가: ₩50,000                                      │
│                                                              │
│  현재 원가: ₩35,000                                          │
│  새 원가:   ┌────────────────┐                               │
│            │ 38,000         │ 원                            │
│            └────────────────┘                               │
│                                                              │
│  변경 사유: (필수)                                            │
│  ┌────────────────────────────────────────────────────────┐ │
│  │ OEM 계약 단가 인상 반영                                  │ │
│  └────────────────────────────────────────────────────────┘ │
│                                                              │
│               [취소]                    [저장]                │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

---

### 3.6 주문 등록/수정 화면 - 계약 유형 선택 (⭐ 신규)

추가분 주문(01, 02...) 등록 시 **계약 유형**을 선택하는 UI입니다.

#### 3.6.1 화면 레이아웃

```
┌─────────────────────────────────────────────────────────────────────────┐
│ 주문 등록                                                          [X]   │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  [기본 정보]                                                              │
│                                                                          │
│  납품요구번호 *                                                           │
│  ┌────────────────────────────────────────────────────────────────────┐ │
│  │ 35-24-3-41787-01                                                   │ │
│  └────────────────────────────────────────────────────────────────────┘ │
│  ℹ️ 번호 입력 시 자동 파싱: 기준번호(35-24-3-41787) + 순번(01)            │
│                                                                          │
│  ─────────────────────────────────────────────────────────────────────  │
│                                                                          │
│  계약 유형 *                                           (순번 01 이상 시)  │
│  ┌────────────────────────────────────────────────────────────────────┐ │
│  │                                                                    │ │
│  │   ○ 기준계약        ○ 변경계약           ○ 별도계약                │ │
│  │   (순번 00만 가능)    (기존 계약 변경)      (새로운 별도 계약)        │ │
│  │                                                                    │ │
│  └────────────────────────────────────────────────────────────────────┘ │
│                                                                          │
│  [변경계약 또는 별도계약 선택 시 표시]                                     │
│  기준 주문 선택 *                                                         │
│  ┌────────────────────────────────────────────────────────────────────┐ │
│  │ 35-24-3-41787-00 (○○아파트, 50,000,000원)                    ▼   │ │
│  └────────────────────────────────────────────────────────────────────┘ │
│                                                                          │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │ ℹ️ 변경계약 안내                                                 │    │
│  │                                                                  │    │
│  │ • 기준 계약(35-24-3-41787-00)과 자금이 합산 관리됩니다.           │    │
│  │ • 기성 청구 시 기준 계약의 품목과 함께 청구됩니다.                 │    │
│  │ • 납품완료도 기준 계약과 함께 처리됩니다.                         │    │
│  └─────────────────────────────────────────────────────────────────┘    │
│                                                                          │
│  ─── 또는 (별도계약 선택 시) ───                                          │
│                                                                          │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │ ⚠️ 별도계약 안내                                                 │    │
│  │                                                                  │    │
│  │ • 별도의 자금 관리 레코드가 생성됩니다.                           │    │
│  │ • 기성 청구 및 납품완료를 별도로 처리해야 합니다.                  │    │
│  │ • 기준 계약과 연관관계만 유지됩니다.                              │    │
│  └─────────────────────────────────────────────────────────────────┘    │
│                                                                          │
│  ... (이하 현장명, 시공사, 품목 등 기존 필드) ...                          │
│                                                                          │
│             [취소]                    [등록하기]                          │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

#### 3.6.2 계약 유형 선택 로직

**1. 순번에 따른 계약 유형 활성화**

| 순번 | 기준계약 | 변경계약 | 별도계약 | 기준 주문 선택 |
|------|----------|----------|----------|----------------|
| 00 | ✅ 선택됨 (고정) | ❌ 비활성 | ❌ 비활성 | 숨김 |
| 01+ | ❌ 비활성 | ✅ 선택가능 | ✅ 선택가능 | 필수 표시 |

**2. 기준 주문 드롭다운 옵션**

```typescript
// 기준 주문 목록 조회 (같은 기준번호의 00번만)
const baseOrderOptions = computed(() => {
  return orders.filter(o => 
    o.baseDeliveryRequestNo === currentBaseNo && 
    o.deliverySeq === 0 &&
    o.contractType === 'ORIGINAL'
  );
});
```

**3. 계약 유형별 안내 메시지**

```typescript
const contractTypeMessages = {
  AMENDMENT: {
    type: 'info',
    icon: 'ℹ️',
    title: '변경계약 안내',
    items: [
      '기준 계약과 자금이 합산 관리됩니다.',
      '기성 청구 시 기준 계약의 품목과 함께 청구됩니다.',
      '납품완료도 기준 계약과 함께 처리됩니다.'
    ]
  },
  SEPARATE: {
    type: 'warning',
    icon: '⚠️',
    title: '별도계약 안내',
    items: [
      '별도의 자금 관리 레코드가 생성됩니다.',
      '기성 청구 및 납품완료를 별도로 처리해야 합니다.',
      '기준 계약과 연관관계만 유지됩니다.'
    ]
  }
};
```

#### 3.6.3 유효성 검사

```typescript
const validationRules = {
  // 납품요구번호 검증
  deliveryRequestNo: [
    { required: true, message: '납품요구번호를 입력해주세요.' },
    { pattern: /^\d{2}-\d{2}-\d-\d{5}-\d{2}$/, message: '올바른 형식이 아닙니다. (예: 35-24-3-41787-00)' }
  ],
  
  // 계약 유형 검증 (순번 01 이상)
  contractType: [
    { 
      validator: (value, formData) => {
        if (formData.deliverySeq > 0 && !value) {
          return '계약 유형을 선택해주세요.';
        }
        if (formData.deliverySeq === 0 && value !== 'ORIGINAL') {
          return '순번 00은 기준계약만 가능합니다.';
        }
        return true;
      }
    }
  ],
  
  // 기준 주문 검증 (변경/별도 계약 시)
  parentOrderId: [
    {
      validator: (value, formData) => {
        if (['AMENDMENT', 'SEPARATE'].includes(formData.contractType) && !value) {
          return '기준 주문을 선택해주세요.';
        }
        return true;
      }
    }
  ]
};
```

#### 3.6.4 폼 상태 관리

```typescript
// components/order/OrderForm.vue

interface OrderFormState {
  deliveryRequestNo: string;      // 전체 납품요구번호
  baseDeliveryRequestNo: string;  // 파싱된 기준번호
  deliverySeq: number;            // 파싱된 순번
  contractType: 'ORIGINAL' | 'AMENDMENT' | 'SEPARATE';
  parentOrderId: number | null;   // 기준 주문 ID
  // ... 기타 필드
}

// 납품요구번호 입력 시 자동 파싱
watch(() => form.deliveryRequestNo, (newValue) => {
  const parsed = parseDeliveryRequestNo(newValue);
  form.baseDeliveryRequestNo = parsed.base;
  form.deliverySeq = parsed.seq;
  
  // 순번에 따라 계약 유형 자동 설정
  if (parsed.seq === 0) {
    form.contractType = 'ORIGINAL';
    form.parentOrderId = null;
  } else {
    // 기본값은 변경계약
    if (!form.contractType || form.contractType === 'ORIGINAL') {
      form.contractType = 'AMENDMENT';
    }
  }
});

// 계약 유형 변경 시 처리
watch(() => form.contractType, (newType) => {
  if (newType === 'ORIGINAL') {
    form.parentOrderId = null;
  }
});
```

#### 3.6.5 API 요청 데이터

```typescript
// 주문 등록 요청
interface OrderCreateRequest {
  deliveryRequestNo: string;        // "35-24-3-41787-01"
  baseDeliveryRequestNo: string;    // "35-24-3-41787"
  deliverySeq: number;              // 1
  contractType: 'ORIGINAL' | 'AMENDMENT' | 'SEPARATE';
  parentOrderId: number | null;     // 기준 주문 ID (변경/별도 시 필수)
  
  siteName: string;
  constructorName: string;
  // ... 기타 필드
}

// 백엔드 처리
// - AMENDMENT: 기준 주문의 fund_id를 공유
// - SEPARATE: 새로운 fund_management 레코드 생성
```

#### 3.6.6 수정 화면 처리

주문 수정 시에는 **계약 유형 변경이 제한**됩니다:

```typescript
// 수정 모드에서 계약 유형 변경 가능 여부
const canChangeContractType = computed(() => {
  if (!isEditMode.value) return true;
  
  // 이미 기성 청구가 있으면 변경 불가
  if (order.baselines && order.baselines.length > 0) {
    return false;
  }
  
  // 자금 수금 이력이 있으면 변경 불가
  if (order.fund && order.fund.progressPaymentTotal > 0) {
    return false;
  }
  
  return true;
});

// 변경 불가 시 안내 메시지
const contractTypeDisabledMessage = '기성 청구 또는 자금 수금 이력이 있어 계약 유형을 변경할 수 없습니다.';
```

#### 3.6.7 UI 컴포넌트

```vue
<!-- components/order/ContractTypeSelector.vue -->
<template>
  <div class="contract-type-selector">
    <!-- 계약 유형 라디오 그룹 -->
    <div class="flex gap-4 mb-4">
      <label 
        v-for="type in contractTypes" 
        :key="type.value"
        class="flex items-center gap-2 cursor-pointer"
        :class="{ 'opacity-50 cursor-not-allowed': !type.enabled }"
      >
        <input
          type="radio"
          :value="type.value"
          v-model="modelValue"
          :disabled="!type.enabled"
          class="form-radio"
        />
        <span>{{ type.label }}</span>
        <span class="text-xs text-gray-500">{{ type.description }}</span>
      </label>
    </div>
    
    <!-- 기준 주문 선택 (변경/별도 시) -->
    <div v-if="showParentOrderSelect" class="mb-4">
      <label class="block text-sm font-medium mb-1">
        기준 주문 선택 <span class="text-red-500">*</span>
      </label>
      <select
        v-model="parentOrderId"
        class="form-select w-full"
        required
      >
        <option :value="null">-- 선택하세요 --</option>
        <option 
          v-for="order in baseOrderOptions" 
          :key="order.orderId"
          :value="order.orderId"
        >
          {{ order.deliveryRequestNo }} ({{ order.siteName }}, {{ formatCurrency(order.contractAmount) }})
        </option>
      </select>
    </div>
    
    <!-- 안내 메시지 -->
    <div 
      v-if="currentMessage" 
      class="p-4 rounded-lg"
      :class="messageClass"
    >
      <div class="font-medium mb-2">
        {{ currentMessage.icon }} {{ currentMessage.title }}
      </div>
      <ul class="list-disc list-inside text-sm space-y-1">
        <li v-for="item in currentMessage.items" :key="item">{{ item }}</li>
      </ul>
    </div>
  </div>
</template>
```

---

### 3.7 주문 목록/상세 수정

#### 3.7.1 주문 목록 변경

**추가 컬럼:**
| 컬럼 | 필드명 | 설명 |
|------|--------|------|
| 순번 | deliverySeq | 00, 01, 02... (배지로 표시) |
| 기준주문 | parentOrderId | 연결 아이콘 표시 |

**표시 예시:**
```
│ 납품요구번호        │ 순번 │ ... │
│ 35-24-3-41787-00  │ [00] │ ... │  ← 기준 (파란색 배지)
│ 35-24-3-41787-01  │ [01] │ ... │  ← 추가분 (회색 배지, 🔗 아이콘)
│ 35-24-3-41787-02  │ [02] │ ... │
```

#### 3.7.2 주문 상세 변경

**탭 추가:**
```
[기본정보] [품목] [출하] [납품확인] [기성/납품확인] [자금]
                                    ↑ 신규           ↑ 신규
```

**기성/납품확인 탭:**
```
┌────────────────────────────────────────────────────────────────────┐
│ 기성 및 납품확인 이력                         [+ 기성 청구하기]     │
├────────────────────────────────────────────────────────────────────┤
│                                                                     │
│ ┌────────────────────────────────────────────────────────────────┐ │
│ │ 차수     │ 유형   │ 확정일     │ 납품수량│ 청구금액   │납품확인서│상태│ │
│ ├────────────────────────────────────────────────────────────────┤ │
│ │ 기성 1차 │ 중간   │ 2024-11-01│ 70개   │ 35,000,000│ 📄 보기 │입금│ │
│ │ 기성 2차 │ 중간   │ 2024-12-01│ 15개   │ 7,500,000 │ 📄 보기 │승인│ │
│ │ 납품완료 │ 최종   │ -         │ 15개   │ 7,500,000 │ -       │대기│ │
│ └────────────────────────────────────────────────────────────────┘ │
│                                                                     │
│ 진행 현황: 주문 100개 중 85개 확정 (85%)                             │
│ 청구 누계: ₩42,500,000 / ₩50,000,000                               │
│                                                                     │
└────────────────────────────────────────────────────────────────────┘
```

---

### 3.8 모바일 주문 요청 관리 (`/admin/order-requests`)

#### 화면 레이아웃

```
┌─────────────────────────────────────────────────────────────────────────┐
│ 📱 모바일 주문 요청 관리                                                  │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│ [필터]                                                                    │
│ 상태: [전체 ▼]  긴급도: [전체 ▼]  기간: [____] ~ [____]  [검색]           │
│                                                                          │
│ [요청 목록]                                                               │
│ ┌────────────────────────────────────────────────────────────────────┐  │
│ │ 🔴│ 요청일     │ 현장명    │ 요청자  │ 품목수│ 긴급 │ 상태 │ 액션  │  │
│ ├────────────────────────────────────────────────────────────────────┤  │
│ │ ● │ 12-08 14:30│ ○○아파트 │ 김현장 │ 3    │ 🚨   │ 대기 │ 처리  │  │
│ │   │ 12-08 10:00│ △△빌딩  │ 이소장 │ 5    │ -    │ 대기 │ 처리  │  │
│ │   │ 12-07 16:00│ □□주택  │ 박감독 │ 2    │ -    │ 승인 │ 상세  │  │
│ └────────────────────────────────────────────────────────────────────┘  │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

#### 요청 처리 모달

```
┌─────────────────────────────────────────────────────────────────────────┐
│ 주문 요청 처리                                                     [X]   │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  [요청 정보]                                                              │
│  요청자: 김현장 (010-1234-5678)                                          │
│  현장: ○○아파트 신축공사                                                 │
│  요청 납품일: 2024-12-10                                                 │
│  긴급도: 🚨 긴급                                                         │
│                                                                          │
│  [요청 품목]                                                              │
│  ┌──────────────────────────────────────────────────────────────────┐   │
│  │ 품목         │ 규격      │ 수량 │ 비고                            │   │
│  ├──────────────────────────────────────────────────────────────────┤   │
│  │ 가로등 A형   │ LP-A001  │ 10  │ -                               │   │
│  │ 가로등 B형   │ LP-B001  │ 5   │ 긴급 요청                        │   │
│  │ 볼라드      │ BL-001   │ 20  │ -                               │   │
│  └──────────────────────────────────────────────────────────────────┘   │
│                                                                          │
│  [처리]                                                                   │
│  ○ 승인  - 연결할 납품요구: [35-24-3-41787 ▼]                            │
│  ○ 반려  - 반려 사유: [________________]                                 │
│                                                                          │
│               [취소]                    [처리 완료]                        │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

---

### 3.9 모바일 - 주문 요청 화면 (`/mobile/order-requests`)

#### 목록 화면

```
┌─────────────────────────────────┐
│ ≡  내 주문 요청       [+ 신규]  │
├─────────────────────────────────┤
│                                  │
│ ┌─────────────────────────────┐ │
│ │ 📅 2024-12-08              │ │
│ │ ○○아파트 신축공사           │ │
│ │ 품목 3건                    │ │
│ │ ┌─────┐                    │ │
│ │ │ 대기 │ 🚨 긴급            │ │
│ │ └─────┘                    │ │
│ └─────────────────────────────┘ │
│                                  │
│ ┌─────────────────────────────┐ │
│ │ 📅 2024-12-05              │ │
│ │ △△빌딩 리모델링             │ │
│ │ 품목 2건                    │ │
│ │ ┌─────┐                    │ │
│ │ │ 승인 │ ✅                 │ │
│ │ └─────┘                    │ │
│ └─────────────────────────────┘ │
│                                  │
└─────────────────────────────────┘
```

#### 신규 요청 화면

```
┌─────────────────────────────────┐
│ ←  주문 요청                    │
├─────────────────────────────────┤
│                                  │
│ 현장명 *                         │
│ ┌─────────────────────────────┐ │
│ │ ○○아파트 신축공사            │ │
│ └─────────────────────────────┘ │
│                                  │
│ 배송지 *                         │
│ ┌─────────────────────────────┐ │
│ │ 서울시 강남구 ...            │ │
│ └─────────────────────────────┘ │
│                                  │
│ 요청 납품일 *                    │
│ ┌─────────────────────────────┐ │
│ │ 📅 2024-12-10               │ │
│ └─────────────────────────────┘ │
│                                  │
│ 긴급도                           │
│ ┌────┐ ┌────┐ ┌────┐          │
│ │긴급│ │보통│ │여유│          │
│ └────┘ └────┘ └────┘          │
│                                  │
│ ─────────────────────────────── │
│                                  │
│ 요청 품목              [+ 추가]  │
│                                  │
│ ┌─────────────────────────────┐ │
│ │ 가로등 A형 (LP-A001)    [X] │ │
│ │ 수량: [10] 개               │ │
│ └─────────────────────────────┘ │
│                                  │
│ ┌─────────────────────────────┐ │
│ │         요청하기             │ │
│ └─────────────────────────────┘ │
│                                  │
└─────────────────────────────────┘
```

---

### 3.10 자금 통계 대시보드 (`/admin/funds/statistics`)

#### 화면 레이아웃

```
┌─────────────────────────────────────────────────────────────────────────┐
│ 📊 자금 현황 대시보드                              기간: [2024년 ▼]      │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│ [전체 현황 카드]                                                          │
│ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐        │
│ │ 총 계약금액   │ │ 수금 누계    │ │ 미수금       │ │ OEM 지급액   │        │
│ │₩500,000,000 │ │₩350,000,000 │ │₩150,000,000 │ │₩280,000,000 │        │
│ └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘        │
│                                                                          │
│ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐                         │
│ │ OEM 미지급   │ │ 현재 수익    │ │ 수익률       │                         │
│ │ ₩70,000,000 │ │ ₩70,000,000 │ │ 20%         │                         │
│ └─────────────┘ └─────────────┘ └─────────────┘                         │
│                                                                          │
│ [차트 영역]                                                               │
│ ┌──────────────────────────────┐ ┌──────────────────────────────┐      │
│ │                              │ │                              │      │
│ │    월별 수금 현황 (Bar)        │ │    기성 진행 현황 (Donut)      │      │
│ │                              │ │                              │      │
│ │    ▓▓▓                       │ │         ████                 │      │
│ │    ▓▓▓ ▓▓                    │ │       ██    ██               │      │
│ │    ▓▓▓ ▓▓ ▓▓▓                │ │      █  70%   █              │      │
│ │   ─────────────              │ │       ██    ██               │      │
│ │    10  11  12                │ │         ████                 │      │
│ │                              │ │                              │      │
│ └──────────────────────────────┘ └──────────────────────────────┘      │
│                                                                          │
│ [계약별 자금 현황 테이블]                                                  │
│ ┌────────────────────────────────────────────────────────────────────┐  │
│ │ 납품요구번호  │ 현장명   │ 계약금액 │ 수금액  │ 미수금  │ 수익   │  │
│ ├────────────────────────────────────────────────────────────────────┤  │
│ │ 35-24-3-41787│ ○○아파트 │ 50M     │ 35M    │ 15M    │ 7M    │  │
│ │ 35-24-3-41788│ △△빌딩 │ 80M     │ 60M    │ 20M    │ 12M   │  │
│ └────────────────────────────────────────────────────────────────────┘  │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

---

### 3.10 출하 수량 추가변경 (`/admin/shipping/edit/[id]`)

출하 완료 후에도 **기성 청구 전**까지 수량 변경을 허용하는 기능입니다.

#### 3.10.1 핵심 비즈니스 규칙

| 출하상태 | 서명상태 | 추가변경 | 후속조치 |
|----------|----------|----------|----------|
| PENDING (대기) | - | ✅ | 변경된 수량으로 정상 프로세스 진행 |
| IN_PROGRESS (진행중) | 서명대기 | ✅ | 변경된 수량으로 서명 진행 |
| PENDING_SIGNATURE (운송완료) | 납품완료 서명대기중 | ✅ | 상태를 IN_PROGRESS로 변경, **메시지 재발송 안내 모달** |
| COMPLETED (기성완료/납품완료) | - | ❌ | 변경 불가 (새 출하 생성 필요) |
| CANCELLED | - | ❌ | 변경 불가 |

**핵심 포인트:**
- 일반변경 없음: 오직 "추가변경"만 존재
- 품목 단위 변경: 전체 수량이 아닌 개별 품목별 수량 변경
- 주문수량 한도 무관: 초과 가능 (추가 납품 허용)
- 변경 사유 필수 입력

#### 3.10.2 출하 상세 페이지 수정

**품목 영역 탭 구조:**
```
┌─────────────────────────────────────────────────────────────────────────┐
│ [현재 품목] [변경 이력]                                        [추가변경] │
├─────────────────────────────────────────────────────────────────────────┤
│ <현재 품목 탭>                                                           │
│ ┌───────────────────────────────────────────────────────────────────┐   │
│ │ 품목명        │ 규격           │ 단위 │ 발주수량 │ 출하수량 │ 금액   │   │
│ ├───────────────────────────────────────────────────────────────────┤   │
│ │ OO단열재      │ 1000×1000×80mm│ m²  │    100   │    150  │ 15M   │   │
│ │ XX보온재      │ 500×500×50mm  │ m²  │     50   │     50  │  5M   │   │
│ └───────────────────────────────────────────────────────────────────┘   │
│                                                                          │
│ <변경 이력 탭>                                                           │
│ ┌───────────────────────────────────────────────────────────────────┐   │
│ │ 변경일시          │ 변경자   │ 변경 사유              │ 상세     │   │
│ ├───────────────────────────────────────────────────────────────────┤   │
│ │ 2025-01-10 14:30  │ 홍길동   │ 현장 추가 요청         │ [보기]  │   │
│ │ 2025-01-08 09:15  │ 김철수   │ 수요기관 수량 조정     │ [보기]  │   │
│ └───────────────────────────────────────────────────────────────────┘   │
│                                                            [이전 인수증] │
└─────────────────────────────────────────────────────────────────────────┘
```

**버튼 상태 제어:**
```typescript
// 추가변경 버튼 표시 조건
const canAdditionalChange = computed(() => {
  const status = shipment.value?.status
  return status && !['COMPLETED', 'CANCELLED'].includes(status)
})

// 메시지 발송 버튼 상태
// - 서명대기/진행중 상태: 활성화
// - 서명완료 후 추가변경 시: 재활성화

// 납품확인서 버튼 상태
// - 서명완료 상태: 활성화
// - 추가변경 후: 비활성화 (재서명 필요)
```

#### 3.10.3 추가변경 모달 (`components/shipment/AdditionalChangeModal.vue`)

```
┌─────────────────────────────────────────────────────────────────────────┐
│ 추가변경                                                            [X]   │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │ ⚠️ 서명이 완료된 상태입니다.                                      │    │
│  │   추가변경 시 재서명이 필요합니다.                                │    │
│  └─────────────────────────────────────────────────────────────────┘    │
│                                                                          │
│  변경 사유 (필수)                                                        │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │ 현장 추가 요청으로 인한 수량 증가                                  │    │
│  └─────────────────────────────────────────────────────────────────┘    │
│                                                                          │
│  [품목별 수량 변경]                                                       │
│  ┌───────────────────────────────────────────────────────────────────┐  │
│  │ 품목명         │ 규격           │ 현재수량 │ 변경수량  │ 차이     │  │
│  ├───────────────────────────────────────────────────────────────────┤  │
│  │ OO단열재       │ 1000×1000×80mm│   100   │ [  150 ] │  +50    │  │
│  │ XX보온재       │ 500×500×50mm  │    50   │ [   50 ] │   0     │  │
│  │ YY자재         │ 300×300×30mm  │    30   │ [   25 ] │  -5     │  │
│  └───────────────────────────────────────────────────────────────────┘  │
│                                                                          │
│  ℹ️ 2개 품목의 수량이 변경됩니다.                                         │
│                                                                          │
│                          [취소]                    [변경 적용]            │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

**기능:**
- 모든 품목 목록 표시 (변경 여부 무관)
- 각 품목별 수량 직접 입력
- 변경 전/후 차이 실시간 표시 (+는 초록, -는 빨강, 0은 회색)
- 서명완료 상태 경고 메시지 (노란색 박스)
- 변경 사유 필수 입력

**Props/Emits:**
```typescript
interface Props {
  isOpen: boolean
  shipmentId: number
  shipmentStatus: string
  items: ShipmentItem[]
}

interface Emits {
  (e: 'close'): void
  (e: 'complete', response: AdditionalChangeResponse): void
}
```

#### 3.10.4 재서명 안내 모달 (`components/shipment/ResignRequiredModal.vue`)

서명완료 상태(PENDING_SIGNATURE)에서 추가변경 후 표시:

```
┌─────────────────────────────────────────────────────────────────────────┐
│ 수량 변경 완료                                                      [X]   │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│                          ✅                                              │
│                                                                          │
│                    수량이 변경되었습니다.                                  │
│                                                                          │
│        서명이 완료된 상태에서 수량이 변경되어                              │
│        재서명이 필요합니다.                                               │
│                                                                          │
│        메시지를 발송하여 새로운 서명을                                     │
│        받아주세요.                                                        │
│                                                                          │
│                     [확인]         [메시지 발송]                          │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

#### 3.10.5 이전 인수증 조회 모달 (`components/shipment/PreviousReceiptsModal.vue`)

서명완료 후 추가변경이 발생한 경우, 이전 인수증 목록 조회:

```
┌─────────────────────────────────────────────────────────────────────────┐
│ 이전 인수증 목록                                                    [X]   │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  ┌───────────────────────────────────────────────────────────────────┐  │
│  │ 생성일시          │ 무효화 사유              │ 다운로드            │  │
│  ├───────────────────────────────────────────────────────────────────┤  │
│  │ 2025-01-10 14:30  │ 수량 추가요청            │ [PDF]              │  │
│  │ 2025-01-08 09:15  │ 초기 서명                │ [PDF]              │  │
│  └───────────────────────────────────────────────────────────────────┘  │
│                                                                          │
│                                                          [닫기]          │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

#### 3.10.6 타입 정의 (`types/shipment-change.ts`)

```typescript
// 추가변경 요청
export interface AdditionalChangeRequest {
  shipmentId: number
  items: AdditionalChangeItem[]
  changeReason: string  // 필수
}

export interface AdditionalChangeItem {
  itemId: number
  currentQuantity: number
  newQuantity: number
}

// 추가변경 응답
export interface AdditionalChangeResponse {
  success: boolean
  requiresResign: boolean     // 재서명 필요 여부 (PENDING_SIGNATURE에서 변경 시 true)
  shipmentStatus: string      // 변경 후 출하 상태
  changedItems: {
    itemId: number
    itemName: string
    beforeQuantity: number
    afterQuantity: number
  }[]
  errorMessage?: string
}

// 수량 변경 이력
export interface QuantityChangeHistory {
  historyId: number
  shipmentId: number
  changedAt: string
  changedBy: string
  changeReason: string
  items: {
    itemId: number
    itemName: string
    beforeQuantity: number
    afterQuantity: number
  }[]
  previousReceiptUrl?: string
}

// 이전 인수증
export interface PreviousReceipt {
  receiptId: number
  shipmentId: number
  createdAt: string
  invalidationReason: string
  pdfUrl: string
}
```

#### 3.10.7 API 연동

| 메서드 | 엔드포인트 | 설명 |
|--------|-----------|------|
| POST | `/admin/shipments/{id}/additional-change` | 추가변경 실행 |
| GET | `/admin/shipments/{id}/change-history` | 수량 변경 이력 조회 |
| GET | `/admin/shipments/{id}/previous-receipts` | 이전 인수증 목록 조회 |

**요청/응답 예시:**

```typescript
// POST /admin/shipments/{id}/additional-change
// Request
{
  items: [
    { itemId: 1, currentQuantity: 100, newQuantity: 150 },
    { itemId: 2, currentQuantity: 30, newQuantity: 25 }
  ],
  changeReason: "현장 추가 요청으로 인한 수량 조정"
}

// Response
{
  success: true,
  requiresResign: true,  // PENDING_SIGNATURE 상태였으므로
  shipmentStatus: "IN_PROGRESS",  // 상태가 변경됨
  changedItems: [
    { itemId: 1, itemName: "OO단열재", beforeQuantity: 100, afterQuantity: 150 },
    { itemId: 2, itemName: "YY자재", beforeQuantity: 30, afterQuantity: 25 }
  ]
}
```

#### 3.10.8 처리 플로우

```
[추가변경 버튼 클릭]
       │
       ▼
[추가변경 모달 오픈]
   - 품목 목록 로드
   - 현재 수량 표시
       │
       ▼
[사용자 입력]
   - 수량 변경
   - 변경 사유 입력
       │
       ▼
[변경 적용 버튼 클릭]
       │
       ▼
[API 호출: additional-change]
       │
       ├─── 실패 ──→ [에러 메시지 표시]
       │
       ▼ 성공
[응답 확인: requiresResign]
       │
       ├─── false (대기/진행중) ──→ [완료 알림] → [데이터 리로드]
       │
       ▼ true (서명완료였음)
[재서명 안내 모달 표시]
   - "메시지 발송" 버튼 클릭 시 메시지 발송 모달로 이동
       │
       ▼
[출하 상태: IN_PROGRESS로 변경]
[메시지 발송 버튼: 활성화]
[납품확인서 버튼: 비활성화]
```

---

## 4. 공통 컴포넌트

### 4.1 신규 컴포넌트

| 컴포넌트 | 위치 | 용도 |
|----------|------|------|
| `FundSummaryCards` | components/fund/ | 자금 현황 요약 카드 |
| `FundProgressBar` | components/fund/ | 수금 진행률 프로그레스바 |
| `ProgressPaymentModal` | components/fund/ | 기성 청구 모달 |
| `FinalDeliveryModal` | components/fund/ | 납품완료 처리 모달 |
| `BaselineItemTable` | components/baseline/ | 차수별 품목 스냅샷 테이블 |
| `CostPriceEditModal` | components/item/ | 원가 수정 모달 |
| `QuantityHistoryModal` | components/shipment/ | 수량 변경 이력 모달 |
| `AdditionalChangeModal` | components/shipment/ | 출하 수량 추가변경 모달 |
| `ResignRequiredModal` | components/shipment/ | 재서명 안내 모달 |
| `PreviousReceiptsModal` | components/shipment/ | 이전 인수증 조회 모달 |
| `OrderRequestCard` | components/mobile/ | 모바일 주문 요청 카드 |
| `OrderRequestProcessModal` | components/admin/ | 주문 요청 처리 모달 |

### 4.2 기존 컴포넌트 수정

| 컴포넌트 | 수정 내용 |
|----------|----------|
| `ItemTable` | 원가, 마진율 컬럼 추가 |
| `OrderTable` | 분할순번 배지, 연결 아이콘 추가 |
| `OrderDetail` | 기성/납품확인, 자금 탭 추가 |

---

## 5. API 연동

### 5.1 신규 API 목록

#### 자금 관리

| 메서드 | 엔드포인트 | 설명 | 요청 | 응답 |
|--------|-----------|------|------|------|
| GET | `/admin/funds` | 목록 조회 | page, size, status, search | FundListResponse |
| GET | `/admin/funds/{id}` | 상세 조회 | - | FundDetailResponse |
| POST | `/admin/funds` | 신규 생성 | FundCreateRequest | FundResponse |
| PUT | `/admin/funds/{id}` | 수정 | FundUpdateRequest | FundResponse |
| GET | `/admin/funds/{id}/payments` | 기성금 이력 | - | PaymentListResponse |
| POST | `/admin/funds/{id}/payments` | 기성금 요청 | PaymentCreateRequest | PaymentResponse |
| POST | `/admin/funds/{id}/payments/{paymentId}/approve` | 기성금 승인 | - | PaymentResponse |
| GET | `/admin/funds/statistics` | 통계 조회 | year, month | FundStatisticsResponse |

#### 기성/납품확인 차수

| 메서드 | 엔드포인트 | 설명 |
|--------|-----------|------|
| GET | `/admin/orders/{orderId}/baselines` | 차수 목록 |
| POST | `/admin/orders/{orderId}/baselines` | 기성/납품완료 차수 생성 |
| GET | `/admin/baselines/{id}` | 차수 상세 (스냅샷 포함) |
| GET | `/admin/baselines/{id}/delivery-confirmation` | 납품확인서 조회 |

#### 모바일 주문 요청

| 메서드 | 엔드포인트 | 설명 |
|--------|-----------|------|
| GET | `/mobile/order-requests` | 내 요청 목록 |
| POST | `/mobile/order-requests` | 요청 생성 |
| GET | `/mobile/order-requests/{id}` | 요청 상세 |
| GET | `/admin/order-requests` | 전체 요청 목록 (관리자) |
| POST | `/admin/order-requests/{id}/approve` | 요청 승인 |
| POST | `/admin/order-requests/{id}/reject` | 요청 반려 |

#### 품목 원가

| 메서드 | 엔드포인트 | 설명 |
|--------|-----------|------|
| PUT | `/admin/items/{id}/cost` | 원가 수정 |
| GET | `/admin/items/{id}/cost-history` | 원가 변경 이력 |

### 5.2 타입 정의

```typescript
// types/fund.ts

interface Fund {
  fundId: number;
  orderId: number;
  deliveryRequestNo: string;
  siteName: string;
  contractTotalAmount: number;
  advancePaymentRate: number;
  advancePaymentAmount: number;
  advancePaymentDate: string | null;
  progressPaymentTotal: number;
  balanceAmount: number;
  oemTotalPaid: number;
  status: 'ACTIVE' | 'COMPLETED' | 'CANCELLED';
  createdAt: string;
  updatedAt: string;
}

interface FundStatistics {
  totalContractAmount: number;
  totalReceived: number;
  totalOutstanding: number;
  totalOemPaid: number;
  totalOemOutstanding: number;
  currentProfit: number;
  profitRate: number;
  monthlyData: MonthlyFundData[];
}

interface ProgressPaymentRequest {
  requestId: number;
  fundId: number;
  requestSeq: number;
  baselineId: number;
  requestAmount: number;
  deliveredQuantity: number;
  deliveryConfirmationId: number | null;
  oemPaymentAmount: number;
  oemPaymentRate: number;
  requestDate: string;
  approvalDate: string | null;
  paymentDate: string | null;
  status: 'REQUESTED' | 'APPROVED' | 'PAID' | 'REJECTED';
  remarks: string | null;
}

// types/baseline.ts

interface Baseline {
  baselineId: number;
  orderId: number;
  baselineSeq: number;
  baselineType: 'PROGRESS' | 'FINAL';  // 기성 또는 납품완료
  baselineDate: string;
  deliveryConfirmationId: number | null;
  totalAmount: number;        // 이번 차수 청구 금액
  totalCost: number;          // 이번 차수 OEM 비용
  cumulativeAmount: number;   // 누적 청구 금액
  cumulativeCost: number;     // 누적 OEM 비용
  createdBy: number;
  status: 'ACTIVE' | 'CANCELLED';
  remarks: string | null;
  items: BaselineItem[];
}

interface BaselineItem {
  id: number;
  baselineId: number;
  itemId: number;
  itemName: string;           // 품목명 스냅샷
  specification: string;      // 규격 스냅샷
  unit: string;               // 단위 스냅샷
  unitPrice: number;          // 납품단가 스냅샷
  costPrice: number;          // 원가 스냅샷
  orderedQuantity: number;    // 주문 수량
  shippedQuantity: number;    // 출하 수량 (누적)
  deliveredQuantity: number;  // 납품 수량 (누적)
  remainingQuantity: number;  // 잔고 수량
  thisTimeQuantity: number;   // 이번 차수 청구 수량
  thisTimeAmount: number;     // 이번 차수 금액
  thisTimeCost: number;       // 이번 차수 OEM 비용
}

// 차수 생성 요청
interface BaselineCreateRequest {
  baselineType: 'PROGRESS' | 'FINAL';
  remarks?: string;
}

// types/mobile-order.ts

interface MobileOrderRequest {
  requestId: number;
  orderId: number | null;
  requesterId: number;
  requesterName: string;
  requesterPhone: string;
  siteName: string;
  deliveryAddress: string;
  requestedDeliveryDate: string;
  urgency: 'URGENT' | 'NORMAL' | 'LOW';
  status: 'REQUESTED' | 'APPROVED' | 'REJECTED' | 'COMPLETED';
  approvedBy: number | null;
  approvedAt: string | null;
  rejectReason: string | null;
  remarks: string | null;
  items: MobileOrderRequestItem[];
}

interface MobileOrderRequestItem {
  id: number;
  requestId: number;
  itemId: number;
  itemName: string;
  specification: string;
  quantity: number;
  unit: string;
  remarks: string | null;
}
```

---

## 6. 상태 관리 (Store)

### 6.1 신규 Store

```typescript
// stores/fund.ts
export const useFundStore = defineStore('fund', {
  state: () => ({
    list: [] as Fund[],
    detail: null as Fund | null,
    statistics: null as FundStatistics | null,
    payments: [] as ProgressPaymentRequest[],
    loading: false,
    pagination: { page: 1, size: 20, total: 0 }
  }),
  
  actions: {
    async fetchList(params: FundSearchParams) { ... },
    async fetchDetail(id: number) { ... },
    async fetchStatistics(year: number) { ... },
    async createFund(data: FundCreateRequest) { ... },
    async updateFund(id: number, data: FundUpdateRequest) { ... },
    async requestPayment(fundId: number, data: PaymentCreateRequest) { ... },
    async approvePayment(fundId: number, paymentId: number) { ... },
  }
});

// stores/baseline.ts
export const useBaselineStore = defineStore('baseline', {
  state: () => ({
    list: [] as Baseline[],
    detail: null as Baseline | null,
    currentQuantities: null as CurrentQuantitySnapshot | null,
    loading: false
  }),
  
  actions: {
    async fetchList(orderId: number) { ... },
    async fetchDetail(id: number) { ... },
    async fetchCurrentQuantities(orderId: number) { ... },
    // 기성 또는 납품완료 차수 생성
    async createBaseline(orderId: number, data: BaselineCreateRequest) { ... },
    async getDeliveryConfirmation(baselineId: number) { ... },
  }
});

// stores/mobileOrderRequest.ts
export const useMobileOrderRequestStore = defineStore('mobileOrderRequest', {
  state: () => ({
    list: [] as MobileOrderRequest[],
    detail: null as MobileOrderRequest | null,
    loading: false
  }),
  
  actions: {
    async fetchMyRequests() { ... },
    async fetchAllRequests(params: SearchParams) { ... },
    async createRequest(data: MobileOrderCreateRequest) { ... },
    async approveRequest(id: number, orderId: number) { ... },
    async rejectRequest(id: number, reason: string) { ... },
  }
});
```

### 6.2 기존 Store 수정

```typescript
// stores/item.ts - 추가 액션
actions: {
  // 기존 액션들...
  
  async updateCostPrice(itemId: number, costPrice: number, reason: string) { ... },
  async fetchCostHistory(itemId: number) { ... },
}

// stores/order.ts - 추가 상태/액션
state: () => ({
  // 기존 상태들...
  
  baselines: [] as Baseline[],
  fundInfo: null as Fund | null,
}),

actions: {
  // 기존 액션들...
  
  async fetchBaselines(orderId: number) { ... },
  async fetchFundInfo(orderId: number) { ... },
}
```

---

## 7. 구현 우선순위

### Phase 1 (2주) - 기반 작업

| 순서 | 작업 | 예상 시간 |
|------|------|----------|
| 1-1 | 타입 정의 (fund, baseline, mobile-order) | 2h |
| 1-2 | API 서비스 함수 작성 | 4h |
| 1-3 | Store 구현 (fund, baseline, mobileOrderRequest) | 4h |
| 1-4 | 품목 관리 - 원가 컬럼 추가 및 수정 모달 | 4h |
| 1-5 | 주문 목록 - 분할순번 표시 추가 | 2h |

### Phase 2 (3주) - 자금 관리 핵심

| 순서 | 작업 | 예상 시간 |
|------|------|----------|
| 2-1 | 자금 관리 목록 화면 | 8h |
| 2-2 | 자금 관리 상세 화면 (탭 구조) | 12h |
| 2-3 | 기성 청구 모달 | 8h |
| 2-4 | 납품완료 처리 모달 | 4h |
| 2-5 | 주문 상세 - 기성/납품확인 탭 추가 | 6h |
| 2-6 | 주문 상세 - 자금 탭 추가 | 4h |

### Phase 3 (2주) - 통계 & 이력

| 순서 | 작업 | 예상 시간 |
|------|------|----------|
| 3-1 | 자금 통계 대시보드 | 12h |
| 3-2 | 수량 변경 이력 모달 | 6h |
| 3-3 | 원가 변경 이력 조회 | 4h |

### Phase 4 (2주) - 모바일

| 순서 | 작업 | 예상 시간 |
|------|------|----------|
| 4-1 | 모바일 주문 요청 목록 (현장소장용) | 6h |
| 4-2 | 모바일 주문 요청 생성 화면 | 8h |
| 4-3 | 관리자 - 주문 요청 관리 화면 | 8h |
| 4-4 | 주문 요청 처리 모달 | 6h |
| 4-5 | 알림 연동 (푸시/카카오) | 4h |

---

## 부록

### A. 상태 배지 색상

| 상태 | 색상 | Tailwind 클래스 |
|------|------|----------------|
| 진행중/ACTIVE | 파란색 | `bg-blue-100 text-blue-800` |
| 완료/COMPLETED | 초록색 | `bg-green-100 text-green-800` |
| 취소/CANCELLED | 회색 | `bg-gray-100 text-gray-800` |
| 요청/REQUESTED | 노란색 | `bg-yellow-100 text-yellow-800` |
| 승인/APPROVED | 파란색 | `bg-blue-100 text-blue-800` |
| 입금/PAID | 초록색 | `bg-green-100 text-green-800` |
| 반려/REJECTED | 빨간색 | `bg-red-100 text-red-800` |
| 긴급/URGENT | 빨간색 | `bg-red-100 text-red-800` |
| 기성 (PROGRESS) | 파란색 | `bg-blue-100 text-blue-800` |
| 납품완료 (FINAL) | 초록색 | `bg-green-100 text-green-800` |

### B. 차수 UI 표시 규칙

| baseline_type | baseline_seq | UI 표시 |
|--------------|--------------|---------|
| PROGRESS | 1 | "기성 1차" |
| PROGRESS | 2 | "기성 2차" |
| PROGRESS | 3 | "기성 3차" |
| FINAL | (any) | "납품완료" |

```typescript
// utils/baseline.ts
export const getBaselineDisplayName = (type: string, seq: number): string => {
  if (type === 'FINAL') return '납품완료';
  return `기성 ${seq}차`;
};
```

### C. 포맷팅 유틸

```typescript
// utils/format.ts

// 금액 포맷 (₩1,234,567)
export const formatCurrency = (value: number): string => {
  return new Intl.NumberFormat('ko-KR', {
    style: 'currency',
    currency: 'KRW'
  }).format(value);
};

// 퍼센트 포맷 (12.5%)
export const formatPercent = (value: number): string => {
  return `${value.toFixed(1)}%`;
};

// 납품요구번호 파싱
export const parseDeliveryRequestNo = (no: string): {
  base: string;
  seq: number;
} => {
  const parts = no.split('-');
  const seq = parseInt(parts.pop() || '0', 10);
  const base = parts.join('-');
  return { base, seq };
};

// 분할순번 표시 (00, 01, 02...)
export const formatDeliverySeq = (seq: number): string => {
  return seq.toString().padStart(2, '0');
};
```

### D. 주문 상태 추적 (delivery_done 기준)

분할납품요구서의 상태는 `delivery_done` 테이블의 `status` 필드를 기준으로 추적됩니다.

#### 상태 정의

| 상태 | 코드 | 설명 | 자동 전이 조건 |
|------|------|------|---------------|
| 대기 | `PENDING` | 발주 생성 완료, 첫 출하 미등록 | 발주 생성 시 자동 |
| 납품중 | `IN_PROGRESS` | 첫 출하 등록됨, 납품 진행 중 | 첫 shipment 등록 시 자동 |
| 서명대기 | `PENDING_SIGNATURE` | 모든 납품확인 완료, 서명 대기 | 모든 delivery COMPLETED 시 자동 |
| 완료 | `COMPLETED` | 양쪽 서명 완료, PDF 생성 | 시공사+감리원 서명 완료 시 자동 |
| 취소 | `CANCELLED` | 취소됨 | 관리자 취소 시 |

#### 상태 전이 흐름

```
발주 생성 → [PENDING]
     ↓
첫 출하 등록 → [IN_PROGRESS]
     ↓
모든 납품확인 완료 → [PENDING_SIGNATURE]
     ↓
양쪽 서명 완료 → [COMPLETED] + 3개 PDF 생성
```

#### 상태별 UI 액션

| 상태 | 메시지 발송 | PDF 다운로드 | 비고 |
|------|-------------|--------------|------|
| PENDING | ❌ | ❌ | 출하 등록 필요 |
| IN_PROGRESS | ❌ | ❌ | 납품 진행 중 |
| PENDING_SIGNATURE | ✅ | ❌ | 서명 링크 발송 가능 |
| COMPLETED | ❌ | ✅ | 납품확인서, 납품완료계, 사진대지 |

#### 주의사항

1. **Order 상태와 DeliveryDone 상태는 독립적**
   - order 취소 시 delivery_done은 별도 처리 필요

2. **모든 납품 완료의 정의**
   - 해당 발주의 모든 shipment → transport → delivery가 COMPLETED

3. **양쪽 서명은 순서 무관**
   - 시공사 먼저 또는 감리원 먼저 - 둘 다 완료되면 COMPLETED 전이

### E. 참고 링크

- [백엔드 PRD](../../ptlpsmback/docs/FEATURE_REQUIREMENTS_V2.md)
- [기존 API 명세서](../API_SPECIFICATION.md)
- [기존 컴포넌트 구조](../REFACTORING.md)

---

**End of Document**
